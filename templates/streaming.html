<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Streaming Response</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 20px;
            white-space: pre-wrap;
            line-height: 1.5;
            margin: 0;
            overflow-x: hidden;
        }
        #content {
            display: inline-block;
            position: relative;
            min-height: 1em;
        }
        .char {
            display: inline;
            opacity: 0;
            animation: fadeIn 0.1s forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        .cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            background-color: #00ff00;
            animation: blink 1s infinite;
            position: absolute;
            bottom: 0;
            margin-left: 2px;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .status {
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="content"></div>
    <div id="cursor" class="cursor"></div>
    <div id="status" class="status">Loading response...</div>
    
    <script>
        const contentDiv = document.getElementById('content');
        const cursor = document.getElementById('cursor');
        const statusDiv = document.getElementById('status');
        let lastContent = '';
        let isTyping = false;
        let typeQueue = [];

        // Function to update status
        function updateStatus(message) {
            statusDiv.textContent = message;
            console.log(`Status: ${message}`);
        }

        // Function to type characters one by one
        function typeCharacter() {
            if (typeQueue.length === 0) {
                isTyping = false;
                positionCursor();
                return;
            }
            
            const char = typeQueue.shift();
            const span = document.createElement('span');
            span.className = 'char';
            span.textContent = char;
            contentDiv.appendChild(span);
            
            // Position cursor after the last character
            positionCursor();
            
            // Schedule next character
            setTimeout(typeCharacter, Math.random() * 20 + 10); // Random delay between 10-30ms
        }
        
        // Position the cursor at the end of the content
        function positionCursor() {
            const range = document.createRange();
            const sel = window.getSelection();
            
            // Create a temporary text node for cursor positioning
            const tempNode = document.createTextNode('');
            contentDiv.appendChild(tempNode);
            
            range.setStart(tempNode, 0);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
            
            const rects = range.getClientRects();
            if (rects.length > 0) {
                const lastRect = rects[0];
                cursor.style.left = `${lastRect.right}px`;
                cursor.style.top = `${lastRect.top}px`;
            }
            
            // Remove the temporary node
            contentDiv.removeChild(tempNode);
            
            // Scroll into view
            cursor.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'end' });
        }

        // Load content from the text file
        async function loadContent() {
            const txtUrl = window.location.href.replace(/\.html$/, '.txt') + '?t=' + Date.now();
            
            try {
                const response = await fetch(txtUrl, { 
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (!response.ok) {
                    updateStatus('Waiting for response to start...');
                    return;
                }
                
                const text = await response.text();
                
                if (text && text.length > lastContent.length) {
                    const newText = text.substring(lastContent.length);
                    lastContent = text;
                    
                    // Add new characters to the queue
                    typeQueue.push(...newText.split(''));
                    
                    // Start typing if not already typing
                    if (!isTyping) {
                        isTyping = true;
                        typeCharacter();
                    }
                    
                    updateStatus(`Receiving response... (${text.length} characters)`);
                } else if (lastContent.length === 0) {
                    updateStatus('Waiting for response to start...');
                } else {
                    updateStatus('Waiting for more content...');
                }
            } catch (error) {
                console.error('Error loading content:', error);
                if (lastContent.length === 0) {
                    updateStatus('Error loading response. Please try again.');
                }
            }
        }
        
        // Load content every 100ms
        setInterval(loadContent, 100);
        
        // Initial load
        loadContent();
        
        // Handle window resize to reposition cursor
        window.addEventListener('resize', positionCursor);
    </script>
</body>
</html>
